name: test-windows

on:
  workflow_dispatch:

jobs:
  build:

    strategy:
      matrix:
        os: [windows-latest]
        haxe: [4.3.3]
      fail-fast: true
    runs-on: windows-latest

    steps:
      # Get branch name
      - name: getBranch
        shell: bash
        run: echo "::set-output name=v::${GITHUB_REF#refs/heads/}"
        id: branch

      # Checkout & install haxe
      - uses: actions/checkout@v4
      - uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ matrix.haxe }}
      - run: haxe -version

      # Install libs
      - run: haxelib install uuid
      - run: haxelib git castle https://github.com/ncannasse/castle
      - run: haxelib git heaps https://github.com/deepnight/heaps.git
      - run: haxelib git hxnodejs https://github.com/HaxeFoundation/hxnodejs.git
      - run: haxelib git electron https://github.com/tong/hxelectron.git
      - run: haxelib git heaps-aseprite https://github.com/AustinEast/heaps-aseprite.git

      # Install haxe API from same branch (if it exists)...
      - name: Install Haxe API from same branch
        id: installApiBranch
        run: haxelib git ldtk-haxe-api https://github.com/deepnight/ldtk-haxe-api.git ${{ steps.branch.outputs.v }} --always
        continue-on-error: true
      # ... or from master otherwise
      - name: Install Haxe API from master
        if: steps.installApiBranch.outcome == 'failure'
        run: |
          haxelib remove ldtk-haxe-api
          haxelib git ldtk-haxe-api https://github.com/deepnight/ldtk-haxe-api.git --always

      # Install deepnightLibs
      - run: haxelib git deepnightLibs https://github.com/deepnight/deepnightLibs.git --always
      - run: haxelib list

      # –î–û–ë–ê–í–¨–¢–ï –ø–µ—Ä–µ–¥ haxe –∫–æ–º–∞–Ω–¥–∞–º–∏ (–ø–æ—Å–ª–µ haxelib list):
      - name: –§–∏–∫—Å deepnightLibs –¥–ª—è 1.5.3
        run: |
          haxelib remove deepnightLibs || true
          haxelib git deepnightLibs https://github.com/deepnight/deepnightLibs.git 1.0.87

      # Node/NPM commands
      - uses: actions/setup-node@v4
        with:
          node-version: '14'
      - run: cd app && npm install

      - name: ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º build:portable –≤ package.json
        shell: bash
        run: |
          cd app
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json'));
            
            pkg.scripts['build:portable'] = 'npm run pack-prepare && electron-builder build --win portable --dir --publish never';
            
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('‚úÖ build:portable –¥–æ–±–∞–≤–ª–µ–Ω!');
          "
      
      # –ó–ê–ú–ï–ù–ò–¢–ï –ë–õ–û–ö npm run compile –Ω–∞ –≠–¢–û (1:1 –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏):
      - name: Build LDtk (README –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ)
        shell: bash
        run: |
          haxe main.debug.hxml
          
          mkdir -p app/assets/js
          haxe renderer.debug.hxml


      # Build portable version
      - name: Build LDtk Portable
        shell: bash
        run: |
          cd app
          npm run build:portable
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: üîç –ß—Ç–æ —Å–æ–∑–¥–∞–ª electron-builder?
        shell: bash
        run: |
          echo "=== –í–°–ï –ø–∞–ø–∫–∏ ==="
          find . -name "dist" -type d || echo "–ù–ï–¢ dist"
          echo "=== app —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ===" 
          ls -la app/
          echo "=== LDtk.exe –ø–æ–∏—Å–∫ ==="
          find . -name "LDtk*.exe" || echo "–ù–ï–¢ LDtk.exe"


      - name: Package Portable LDtk (–§–ò–ù–ê–õ–¨–ù–û)
        shell: bash
        run: |
          cd app/redist/win-unpacked
          powershell -Command "
            Compress-Archive -Path 'LDtk.exe', '../../resources', '../../node_modules' -DestinationPath '../../../LDtk-windows-portable.zip' -Force
          "

      # Upload portable build as artifact
      - name: Upload Portable Build
        uses: actions/upload-artifact@v4
        with:
          name: ldtk-windows-portable-${{ steps.branch.outputs.v }}
          path: app/dist/LDtk-windows-portable.zip
          retention-days: 30
